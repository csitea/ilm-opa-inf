
# ilm-opa MAINTENANCE AND OPERATIONS GUIDE

## ON THE HOST

# authenticate with the

```sh

export ORG=ilm APP=opa ENV=dev ;
export TGT_PRODUCT_PATH="/opt/$ORG/$ORG-$APP/$ORG-$APP-dat"
export CNF_PRODUCT_PATH="/opt/$ORG/$ORG-$APP/$ORG-$APP-cnf"
export KEY_FPATH=$(eval echo ~/.gcp/.$ORG/${ORG}-${APP}-${ENV}-sa-compute-instance.json)
gcloud auth activate-service-account sa-compute-instance@${ORG}-${APP}-${ENV}.iam.gserviceaccount.com --key-file=$KEY_FPATH


gsutil cp -r gs://${ORG}-${APP}-${ENV}-site/2024/07/** $TGT_PRODUCT_PATH/gallery-src-imgs/

cd $TGT_PRODUCT_PATH/gallery-src-imgs/

find . -type f -regextype posix-extended -regex '.*[0-9]+x[0-9]+.*' -delete
quit_on "remove all of the <<num>>x<<num>>.<<ext>> files"


find . -type f \( -iname '*.jpg' -o -iname '*.png' -o -iname '*.jpeg' -o -iname '*.gif' \) -print0 | \
xargs -0 -I{} identify -format '%w %h %i\n' "{}" | \
awk '($1 < 300 || $2 < 450) {print $3}' | \
xargs -I{} sh -c 'echo "Deleting: {}"; rm -fv "{}"'
quit_on "# remove the smallest imgs"

cp -v $CNF_PRODUCT_PATH/cnf/py/sigal/sigal.conf.py $TGT_PRODUCT_PATH/gallery/
quit_on "copying the sigal conf file"

sudo apt update -y
quit_on "updating the repositories"


sudo apt install -y python3-venv
quit_on "installing python3-venv"

sudo apt install -y imagemagick
quit_on "installing the cli tool for the svg -> jpeg conversion , imagemagick"


python3 -m venv .venv
quit_on "Create a virtual environment named '.venv'"


source .venv/bin/activate
quit_on "Activate the virtual environment"


find $TGT_PRODUCT_PATH/gallery-src-imgs/ -name '*.svg' \
    -exec sh -c 'convert "$1" "${1%.svg}.jpeg"' _ {} \;
quit_on "converting all the svg images to jpeg files"

rm -r $TGT_PRODUCT_PATH/gallery-src-imgs/*.svg
quit_on "remove all of the svg files from the source dir- they brake sigal"

pip install sigal
quit_on "Install sigal in the virtual environment"


sigal build

cd $TGT_PRODUCT_PATH/gallery/_build/


perl -pi -e 's|<span>Generated by <a href="https://github.com/saimn/sigal">sigal</a></span>||g' index.html

perl -pi -e 's|<h1><a href="./">gallery-src-imgs</a></h1>|<title></title>|g' index.html

# on the server
sudo mkdir -p /var/www/html/pub/gallery/
sudo mv -v gallery/_build/* /var/www/html/pub/gallery/

```
